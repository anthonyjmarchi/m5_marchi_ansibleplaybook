---
- hosts: localhost 
  gather_facts: no
  module_defaults:
    group/aws:
      region: "us-east-2"
  tasks:
    - name: Create VPC
      ec2_vpc_net:
        name: Module5
        cidr_block: 10.10.0.0/16
        tags:
          Module: 5
        state: present 
      register: vpc
    - name: debug
      debug: var=vpc
    - name: Create public subnet
      ec2_vpc_subnet:
         vpc_id: "{{ vpc.vpc.id }}"
         tags: 
           Name: Module5 public
           Module: 5
         cidr: 10.10.0.0/24
         state: present 
      register: public_subnet
    - name: Create private subnet first
      ec2_vpc_subnet:
         vpc_id: "{{ vpc.vpc.id }}"
         tags: 
           Name: Module5 privateOne
           Module: 5
         cidr: 10.10.1.0/24
         state: present 
    - name: Create private subnet second
      ec2_vpc_subnet:
         vpc_id: "{{ vpc.vpc.id }}"
         tags:
           Name: Module5 priavteTwo
           Module: 5
         cidr: 10.10.2.0/24
         state: present
         az: us-east-1a
    - name: Create internet gateway
      ec2_vpc_igw:
         vpc_id: "{{ vpc.vpc.id }}"
         tags: 
           Name: Module5 gateway
         state: present
      register: igw
    - name: Create public route table
      ec2_vpc_route_table:
         vpc_id: "{{ vpc.vpc.id }}"
         tags: 
           Name: Module5RouteTablePublic
         subnets:
           - "{{ public_subnet.subnet.id }}"
         routes: 
           - dest: 0.0.0.0/0
             gateway_id: "{{ igw.gateway_id }}"
    - name: Create private route table
      ec2_vpc_route_table:
         vpc_id: "{{ vpc.vpc.id }}"
         tags:
           Name: Module5RouteTablePrivate
         subnets:
           - "{{ public_subnet.subnet.id }}"
         routes:
           - dest: 0.0.0.0/0
             gateway_id: "{{ igw.gateway_id }} " 
    - name: Create security group
      ec2_group:
         name: Module5-developer-sg
         description: Developer security group
         vpc_id: "{{ vpc.vpc.id }}"
         rules:
           - proto: tcp
             ports:
               - 22
               - 80
             cidr_ip: 0.0.0.0/0
             rule_desc: allow all to ports 22 and 80
         state: present
    - name: "Create public acl"
      ec2_vpc_nacl:
         vpc_id: " {{ vpc.vpc.id }} "
         name: public-acl
         region: us-east-1
         subnets: "{{ public_subnet.subnet.id }}"
         tags:
           Name: Module5publicACL
         ingress:         
             - [100, 'tcp', 'allow', '0.0.0.0/0', null, null, 22]
             - [500, 'tcp', 'allow', '24.239.105.213/32', null, null, 5000]
             - [600, 'tcp', 'allow', '24.196.25.139/32', null, null, 5000]
             - [700, 'tcp', 'allow', '73.99.116.234/32', null, null, 5000]
             - [800, 'tcp', 'allow', '98.204.70.130/32', null, null, 5000]
             - [900, 'tcp', 'allow', '0.0.0.0/0', null, null, 1024, 65535]
             - [300, 'tcp', 'allow', '0.0.0.0/0', null, null, 443]
             - [400, 'tcp', 'allow', '0.0.0.0/0', null, null, 80]
         egress:
             - [100, 'tcp', 'allow', '0.0.0.0/0', null, 80, 80] 
             - [200, 'tcp', 'allow', '0.0.0.0/0', null, 443, 443]
             - [900, 'tcp', 'allow', '0.0.0.0/0', null, 1024, 65535]
         state: 'present'
    - name: "Create private acl"
      ec2_vpc_nacl:
         vpc_id: " {{ vpc.vpc.id }} "
         name: private-acl
         region: us-east-1
         subnets: "{{ public_subnet.subnet.id }}"
         tags:
           Name: Module5privateACL
         ingress:
             - [100, 'tcp', 'allow', '0.0.0.0/0', null, null, 5432]
             - [500, 'tcp', 'allow', '0.0.0.0/0', null, null, 22]
         egress:
             - [900, 'tcp', 'allow', '0.0.0.0/0', null, null, 1024, 65535]
         state: 'present'
    - name: Create NAT gateway
      ec2_vpc_nat_gateway:
        subnet_id: "{{ public_subnet.subnet.id }}"
        if_exist_do_not_create: true
        state: present
        wait: yes
      register: nat
    - name: Create ig-postgres security group
      ec2_group:
         name: Module5-postgres-sg
         description: postgres security group
         vpc_id: "{{ vpc.vpc.id }}"
         rules:
           - proto: tcp
             ports:
               - 5432
             cidr_ip: 0.0.0.0/0
             rule_desc: allow all to ports 5432
         state: present
    - name: Create ig-postgres-tag security group
      ec2_group:
         name: Module5-postgres-tag-sg
         description: postgres tag security group
         vpc_id: "{{ vpc.vpc.id }}"
         rules:
           - proto: tcp
             ports:
               - 5432
             cidr_ip: 0.0.0.0/0
             rule_desc: allow all to ports 5432
         state: present
    - name: Create ig-postgres-tag security group
      ec2_group:
         name: Module5-ig-postgres-tag-sg
         description: postgres tag security group
         vpc_id: "{{ vpc.vpc.id }}"
         rules:
           - proto: tcp
             ports:
               - 5432
         rules_egress:
           - proto: tcp
             ports: 
               - 5432
         state: present
    - name: Create nginx security group
      ec2_group:
         name: Module5-nginx-sg
         description: nginx security group
         vpc_id: "{{ vpc.vpc.id }}"
         rules:
           - proto: tcp
             ports: 80
             cidr_ip: 0.0.0.0/0
           - proto: tcp 
             ports: 80
             cidr_ip: ::/0
           - proto: tcp
             ports: 22
             cidr_ip: 0.0.0.0/0
           - proto: tcp
             ports: 22
             cidr_ip: ::/0
         rules_egress:
           - proto: tcp
             cidr_ip: 0.0.0.0/0
         state: present
    - rds_subnet_group:
        state: present
        name: ig-private-dbgrp 
        description: security group for db
        subnets:
          - "" 
          - ""
    - name: Create an ec2 launch template
      ec2_launch_template:
         name: "my_template"
         image_id: "ami-04b762b4289fba92b"
         key_name: my_ssh_key
         instance_type: t2.micro
         iam_instance_profile: myTestProfile
    disable_api_termination: true


